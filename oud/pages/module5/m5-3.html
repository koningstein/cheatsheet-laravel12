<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>M5.3: Orders Opslaan - Laravel 12</title>
    <link rel="stylesheet" href="../../../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="../../../script.js" defer></script>
</head>
<body>
<div class="top-bar"><div class="top-bar-content"><div class="nav-group"><a href="../module4/m4-8.html">« Module 4</a><a href="../module6/m6-1.html">Module 6 »</a></div><div class="nav-group theme-switcher"><select id="theme-switcher"><option value="blue">Blauw</option></select></div></div></div>

<div class="container">
    <div class="header-nav-block">
        <header>
            <h1>Module 5: Orders & Validatie</h1>
            <p>Het verwerken van bestellingen, PDF generatie en validatie vertalingen.</p>
        </header>
        <nav>
            <ul>
                <li><a href="m5-1.html">M5.1: Orders Structuur</a></li>
                <li><a href="m5-2.html">M5.2: Order Seeds</a></li>
                <li><a href="m5-3.html" class="active">M5.3: Orders Opslaan</a></li>
                <li><a href="m5-4.html">M5.4: Orders Tonen</a></li>
                <li><a href="m5-5.html">M5.5: Order naar PDF</a></li>
            </ul>
        </nav>
    </div>

    <main>
        <h2>M5.3: Orders Opslaan</h2>

        <h3>Leeruitkomsten</h3>
        <ul>
            <li>Ik kan de inhoud van de winkelwagen omzetten naar database records (Order & Orderrows).</li>
            <li>Ik kan de winkelwagen legen na een bestelling.</li>
        </ul>

        <h3>Stap 1: OrderController Aanmaken</h3>
        <p>We maken een controller om de orders af te handelen. Zet deze in de <code>Open</code> map, omdat de klant dit doet.</p>
        <pre><code class="language-bash">php artisan make:controller Open/OrderController</code></pre>

        <h3>Stap 2: Store Methode (Bestellen)</h3>
        <p>In de <code>store</code> methode doen we het volgende:</p>
        <ol>
            <li>Maak een nieuwe Order aan voor de ingelogde user.</li>
            <li>Loop door de items in de <code>Cart</code>.</li>
            <li>Maak voor elk item een <code>Orderrow</code>.</li>
            <li>Leeg de winkelwagen.</li>
        </ol>

        <div class="note-box">Bestand: <code>app/Http/Controllers/Open/OrderController.php</code></div>
        <pre><code class="language-php">
use Gloudemans\Shoppingcart\Facades\Cart;
use Illuminate\Support\Facades\Auth;
use App\Models\Order;
use App\Models\Orderrow;

public function store(): RedirectResponse
{
    // Check of er iets in de kar zit
    if (Cart::count() == 0) {
        return back()->with('error', 'Winkelwagen is leeg!');
    }

    // 1. Maak de Order
    $order = new Order();
    $order->user_id = Auth::id();
    $order->state_id = 1; // 'Pending' (zoals geseed in M5.2)
    $order->orderdate = now();
    $order->save();

    // 2. Loop door de winkelwagen
    foreach (Cart::content() as $item) {
        $row = new Orderrow();
        $row->order_id = $order->id;
        $row->product_id = $item->id;
        $row->qty = $item->qty;
        $row->price = $item->price; // Huidige prijs vastleggen
        $row->save();
    }

    // 3. Leeg de winkelwagen
    Cart::destroy();

    return to_route('open.orders.index')
            ->with('status', 'Bestelling geplaatst!');
}
        </code></pre>

        <h3>Stap 3: Route Maken</h3>
        <p>We hebben een route nodig die aangeroepen wordt als men op "Afrekenen" klikt.</p>

        <div class="note-box">Bestand: <code>routes/web.php</code></div>
        <pre><code class="language-php">
use App\Http\Controllers\Open\OrderController;

Route::middleware(['auth'])->group(function () {
    Route::post('/orders', [OrderController::class, 'store'])->name('open.orders.store');
});
        </code></pre>

        <h3>Stap 4: Knop Koppelen</h3>
        <p>Pas de "Afrekenen" knop in <code>resources/views/open/cart/index.blade.php</code> aan zodat het een formulier is.</p>

        <pre><code class="language-html">
&lt;form action="{{ route('open.orders.store') }}" method="POST"&gt;
    @csrf
    &lt;button type="submit" class="bg-green-600 text-white px-6 py-3 rounded"&gt;
        Definitief Bestellen
    &lt;/button&gt;
&lt;/form&gt;
        </code></pre>
    </main>
</div>
<footer><div class="footer-content"><p>&copy; 2025 Techniek College Rotterdam</p></div></footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
</body>
</html>