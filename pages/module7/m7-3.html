<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Many to Many - Eloquent ORM - Laravel 12</title>
    <link rel="stylesheet" href="../../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="../../script.js" defer></script>
</head>
<body>
<div class="top-bar"><div class="top-bar-content"><div class="nav-group"><a href="../module6/m6-8.html">« Database & Models</a><a href="../module8/m8-1.html">Routing & Controllers »</a></div><div class="nav-group theme-switcher"><select id="theme-switcher"><option value="blue">Blauw</option></select></div></div></div>

<div class="container">
    <div class="header-nav-block">
        <header>
            <h1>Eloquent ORM</h1>
            <p>Geavanceerd werken met data, relaties, accessors en scopes.</p>
        </header>
        <nav>
            <ul>
                <li><a href="m7-1.html">One to One</a></li>
                <li><a href="m7-2.html">One to Many</a></li>
                <li><a href="m7-3.html" class="active">Many to Many</a></li>
                <li><a href="m7-4.html">Eager Loading</a></li>
                <li><a href="m7-5.html">Query Scopes</a></li>
                <li><a href="m7-6.html">Collections Methods</a></li>
                <li><a href="m7-7.html">Pivot Tabellen</a></li>
            </ul>
        </nav>
    </div>

    <main>
        <h2>Many to Many (BelongsToMany)</h2>
        <p>Een veel-op-veel relatie is complexer omdat beide kanten meerdere verbindingen kunnen hebben. Een database kan dit niet direct opslaan in de tabellen zelf (zoals bij One-to-Many). We hebben een derde tabel nodig: de <strong>Pivot Tabel</strong> (tussentabel).</p>

        <p><strong>Voorbeeld:</strong></p>
        <ul>
            <li>Een <strong>User</strong> kan meerdere <strong>Roles</strong> hebben (bijv. 'Admin' én 'Editor').</li>
            <li>Een <strong>Role</strong> kan aan meerdere <strong>Users</strong> gekoppeld zijn.</li>
        </ul>

        <h3>Stap 1: De Database Structuur (Pivot Tabel)</h3>
        <p>Laravel heeft strikte naamgevingsconventies voor de tussentabel:</p>
        <ol>
            <li>Neem de namen van de twee modellen (enkelvoud).</li>
            <li>Zet ze op <strong>alfabetische volgorde</strong>.</li>
            <li>Verbind ze met een underscore (<code>_</code>).</li>
        </ol>
        <p>Voor <code>User</code> en <code>Role</code> wordt dit dus: <strong><code>role_user</code></strong>.</p>

        <div class="note-box">Bestand: <code>database/migrations/xxxx_create_role_user_table.php</code></div>
        <pre><code class="language-php">
Schema::create('role_user', function (Blueprint $table) {
    // We hebben meestal geen eigen 'id' nodig, maar het mag wel.
    $table->id();

    // De twee sleutels
    $table->foreignId('user_id')->constrained()->onDelete('cascade');
    $table->foreignId('role_id')->constrained()->onDelete('cascade');

    // Zorg dat een user dezelfde rol niet 2x kan krijgen
    $table->unique(['user_id', 'role_id']);
});
        </code></pre>

        <h3>Stap 2: Relaties in Models</h3>
        <p>In een Many-to-Many relatie gebruiken beide models <code>belongsToMany</code>.</p>

        <div class="note-box">Bestand: <code>app/Models/User.php</code></div>
        <pre><code class="language-php">
use Illuminate\Database\Eloquent\Relations\BelongsToMany;

public function roles(): BelongsToMany
{
    // Laravel zoekt automatisch naar 'role_user', 'user_id' en 'role_id'
    return $this->belongsToMany(Role::class);
}
        </code></pre>

        <div class="note-box">Bestand: <code>app/Models/Role.php</code></div>
        <pre><code class="language-php">
public function users(): BelongsToMany
{
    return $this->belongsToMany(User::class);
}
        </code></pre>

        <h3>Stap 3: Koppelen (Attach)</h3>
        <p>Om een relatie te maken (een rij toevoegen in de tussentabel), gebruik je <code>attach()</code>. Je hoeft niet zelf met de <code>role_user</code> tabel te werken.</p>

        <div class="note-box">Bestand: <code>app/Http/Controllers/UserController.php</code></div>
        <pre><code class="language-php">
$user = User::find(1);
$roleId = 5;

// Voegt rol 5 toe aan deze user
$user->roles()->attach($roleId);

// Je kunt ook een array geven: voeg rol 5 en 6 toe
$user->roles()->attach([5, 6]);
        </code></pre>

        <h3>Stap 4: Ontkoppelen (Detach)</h3>
        <p>Om een relatie te verwijderen (rij weg uit tussentabel), gebruik je <code>detach()</code>.</p>
        <pre><code class="language-php">
// Verwijdert rol 5 van deze user
$user->roles()->detach($roleId);

// Verwijdert ALLE rollen van deze user
$user->roles()->detach();
        </code></pre>

        <h3>Stap 5: Synchroniseren (Sync) - *Belangrijk!*</h3>
        <p>Dit is de handigste functie voor formulieren met checkboxes. <code>sync()</code> accepteert een lijst met ID's die de gebruiker <strong>moet hebben</strong>.</p>
        <ul>
            <li>Staat een ID in de lijst maar niet in de DB? -> <strong>Attach</strong></li>
            <li>Staat een ID in de DB maar niet in de lijst? -> <strong>Detach</strong></li>
            <li>Staat hij in allebei? -> <strong>Niets doen</strong></li>
        </ul>

        <pre><code class="language-php">
// Stel in het formulier waren rol 1 en 3 aangevinkt.
// De user had misschien rol 2 en 3.
// Resultaat: Rol 2 wordt verwijderd, Rol 1 wordt toegevoegd, Rol 3 blijft.
$user->roles()->sync([1, 3]);
        </code></pre>

        <h3>Stap 6: Toggle</h3>
        <p>Soms wil je een "aan/uit" knop maken (bijv. 'Like' of 'Favoriet'). <code>toggle()</code> voegt toe als het er niet is, en verwijdert als het er wel is.</p>
        <pre><code class="language-php">
$user->roles()->toggle($roleId);
        </code></pre>

        <h3>Stap 7: Data Ophalen & Filteren</h3>
        <p>Je kunt de relaties gewoon gebruiken als eigenschap.</p>
        <pre><code class="language-php">
// Alle rollen van de user
foreach ($user->roles as $role) {
    echo $role->name;
}

// Filteren: Haal alle users op die de rol 'Admin' hebben
// We gebruiken hier 'whereHas'
$admins = User::whereHas('roles', function ($query) {
    $query->where('name', 'Admin');
})->get();
        </code></pre>
    </main>
</div>
<footer><div class="footer-content"><p>&copy; 2025 Techniek College Rotterdam</p></div></footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
</body>
</html>